/**
 * angular-console
 * @version v0.0.1 - 2015-01-23
 * @link https://github.com/gampleman/angular-console
 * @author Jakub Hampl <>
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
"use strict";angular.module("AngularConsole",[]).directive("console",["$q",function(a){return{restrict:"E",transclude:!0,scope:{resultPrefix:"=?",helpText:"=?",placeholder:"@",scripts:"=?",inject:"=?"},controller:["$scope","$element",function(b,c){function d(a,b){return a.toLowerCase()<b.toLowerCase()?-1:1}var e=this;this.load=function(b){var c=a.defer(),d=document.createElement("script");return d.type="text/javascript",d.addEventListener("load",function(){c.resolve("Loaded "+b)},!1),d.src=b,this.iframe?(this.iframe.contentDocument.body.appendChild(d),c.promise):void 0},this.evaluate=function(a){if(!a)return!1;var b={command:a};try{b.result=this.sandbox.eval(a),_.isUndefined(b.result)&&(b.type="undefined"),_.isNumber(b.result)&&(b.type="number"),_.isString(b.result)&&(b.type="string")}catch(c){b.result=c.toString(),b.type="error"}return console.log(b),this.addHistory(b)},this.addHistory=function(c){return a.when(c.result).then(function(){_.isString(c.result)&&(c.result='"'+c.result.toString().replace(/"/g,'\\"')+'"'),_.isFunction(c.result)&&(c.result=c.result.toString().replace(/"/g,'\\"')),_.isObject(c.result)&&(c.result=e.stringify(c.result).replace(/"/g,'\\"')),_.isUndefined(c.result)&&(c.result="undefined")}),b.history.push(c),this},this.stringify=function f(a,b,c){var e,g,h="",i="",j=[],k=[],l=!1;c=c||[];try{i={}.toString.call(a)}catch(m){i="[object Object]"}for(g=0;g<c.length;g++)if(a===c[g]){l=!0;break}if(l)h="[circular]";else if("[object String]"===i)h='"'+a.replace(/"/g,'\\"')+'"';else if("[object Array]"===i){for(c.push(a),h="[",e=0;e<a.length;e++)j.push(f(a[e],b,c));h+=j.join(", ")+"]"}else if("[object Object]"===i){c.push(a),h="{";for(e in a)k.push(e);for(k.sort(d),e=0;e<k.length;e++)j.push(f(k[e],void 0,c)+": "+f(a[k[e]],b,c));h+=j.join(", ")+"}"}else if("[object Number]"===i)h=a+"";else if("[object Boolean]"===i)h=a?"true":"false";else if("[object Function]"===i)h=a.toString();else if(null===a)h="null";else if(void 0===a)h="undefined";else if(void 0===b){c.push(a),h=i+"{\n";for(e in a)k.push(e);for(k.sort(d),e=0;e<k.length;e++)try{j.push(k[e]+": "+f(a[k[e]],!0,c))}catch(m){"NS_ERROR_NOT_IMPLEMENTED"===m.name}h+=j.join(",\n")+"\n}"}else try{h=a+""}catch(m){}return h},b.keydown=function(a){if(_([16,17,18]).indexOf(a.which,!0)>-1&&(e.ctrl=!0),13===a.which){a.preventDefault();var d=a.target.value;return e.ctrl?(a.target.value=d+"\n",!1):(a.target.value="",e.specialCommands(d)||e.evaluate(d),e.historyState=b.history.length,setTimeout(function(){c.find(".output").scrollTop(c.find(".output")[0].scrollHeight-c.find(".output").height())}),!1)}if(!e.ctrl&&(38===a.which||40===a.which)){a.preventDefault();var f=a.which-39;return e.historyState+=f,e.historyState<0?e.historyState=0:e.historyState>=b.history.length&&(e.historyState=b.history.length),a.target.value=b.history[e.historyState]?b.history[e.historyState].command:"",!1}if(9===a.which){a.preventDefault();var g=a.target.value,h=a.target.selectionStart,i=[g.slice(0,h),g.slice(h,g.length)];return a.target.value=i[0]+(e.tabCharacter||"	")+i[1],a.target.selectionStart=h+e.tabCharacter.length,a.target.selectionEnd=h+e.tabCharacter.length,!1}},b.keyup=function(a){_([16,17,18]).indexOf(a.which,!0)>-1&&(e.ctrl=!1)},this.inject=function(a){try{_.each(a,function(a){e.sandbox.eval("var "+a+' = angular.element(document).injector().get("'+a+'");')})}catch(b){return"Error: Injection failed: "+b.message+"\nHave you initialized Angular properly?"}return"Injected the following into the current scope: "+a.join(", ")},this.specialCommands=function(a){return":clear"===a?(b.history=[],!0):":help"===a?this.addHistory({command:":help",result:b.helpText}):a.indexOf(":load")>-1?this.addHistory({command:a,result:this.load(a.substring(6))}):a.indexOf(":inject")>-1?this.addHistory({command:a,result:this.inject(a.substring(8).trim().split(/\s*,\s*/))}):!1}}],template:'<pre class="output"><span class="command" ng-repeat-start="item in history | filter: hidden">{{item.command}}</span>\n<span class="prefix">{{ resultPrefix }}</span><span ng-class="item.type" ng-repeat-end gm-unwrap-promise="item.result">\n</span></pre><div class="input"><textarea rows="1" placeholder="{{ placeholder }}" ng-keyup="keyup($event)" ng-keydown="keydown($event)"></textarea></div>',compile:function(b,c,d){return function(b,e,f,g){b.history=[];var h=$('<iframe width="0" height="0"/>').css({visibility:"hidden"}),i=a.defer();"src"in c?(h.attr("src",c.src),h.on("load",function(){i.resolve(!0)})):i.resolve(!1),h.appendTo("body"),g.iframe=h[0],g.sandbox=g.iframe.contentWindow,!g.sandbox.eval&&g.sandbox.execScript&&g.sandbox.execScript("null"),b.helpText||(b.helpText='type javascript commands into the console, hit enter to evaluate. \n[up/down] to scroll through history, ":clear" to reset it. \n[alt + return/up/down] for returns and multi-line editing.\n:load SCRIPTURL to load a script\n:inject VAR to make the angular injector inject a variable into local scope.\nThis requires Angular to be loaded in the current context.');var j=function(){return b.scripts?_.reduce(b.scripts,function(a,b){return a.then(function(){return g.load(b)})},a.when([])):a.when([])};i.promise.then(j).then(function(){b.inject&&g.inject(b.inject),d(b,function(a){var c=_(a.text().split(/\/\/\s*=>.+?\n(\/\/.+?\n)*/)).map(function(a){return a&&a.trim()}).filter(function(a){return a&&""!==a}).each(g.evaluate,g);console.log(c.value(),b.history),g.historyState=b.history.length})})}}}}]).directive("gmUnwrapPromise",["$q",function(a){return{restrict:"A",scope:{promise:"=gmUnwrapPromise"},link:function(b,c){c.text("...\n"),a.when(b.promise).then(function(a){c.text(a+"\n")})}}}]);