/**
 * angular-console
 * @version v0.2.0 - 2015-05-28
 * @link https://github.com/gampleman/angular-console
 * @author Jakub Hampl <>
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
"use strict";angular.module("AngularConsole",[]).directive("console",function(a,b){return{restrict:"E",transclude:!0,scope:{resultPrefix:"=?",helpText:"=?",placeholder:"@"},controller:function(b,c){var d=this;this.addHistory=function(a){return b.history.push(a),this},this.evaluate=function(a){this.addHistory({command:a,resultPromise:this.evaluator.evaluate(a)})},b.keydown=function(a){if(_([16,17,18]).indexOf(a.which,!0)>-1&&(d.ctrl=!0),13===a.which){a.preventDefault();var e=a.target.value;return d.ctrl?(a.target.value=e+"\n",!1):(a.target.value="",d.specialCommands(e)||d.evaluate(e),d.historyState=b.history.length,setTimeout(function(){c.find(".output").scrollTop(c.find(".output")[0].scrollHeight-c.find(".output").height())}),!1)}if(!d.ctrl&&(38===a.which||40===a.which)){a.preventDefault();var f=a.which-39;return d.historyState+=f,d.historyState<0?d.historyState=0:d.historyState>=b.history.length&&(d.historyState=b.history.length),a.target.value=b.history[d.historyState]?b.history[d.historyState].command:"",!1}if(9===a.which){a.preventDefault();var g=a.target.value,h=a.target.selectionStart,i=[g.slice(0,h),g.slice(h,g.length)];return a.target.value=i[0]+(d.tabCharacter||"	")+i[1],a.target.selectionStart=h+d.tabCharacter.length,a.target.selectionEnd=h+d.tabCharacter.length,!1}},b.keyup=function(a){_([16,17,18]).indexOf(a.which,!0)>-1&&(d.ctrl=!1)},this.specialCommands=function(c){return":clear"===c?(b.history=[],!0):":help"===c?this.addHistory({command:":help",resultPromise:a.when({result:b.helpText,type:"builtin"})}):!1}},template:'<pre class="output"><span class="command" ng-repeat-start="item in history | filter: hidden">{{item.command}}</span>\n<span class="prefix">{{ resultPrefix }}</span><span ng-repeat-end gm-unwrap-promise="item.resultPromise">\n</span></pre><div class="input"><textarea rows="1" placeholder="{{ placeholder }}" ng-keyup="keyup($event)" ng-keydown="keydown($event)"></textarea></div>',compile:function(a,c,d){return function(a,e,f,g){a.history=[],a.helpText||(a.helpText='type javascript commands into the console, hit enter to evaluate. \n[up/down] to scroll through history, ":clear" to reset it. \n[alt + return/up/down] for returns and multi-line editing.\n:load SCRIPTURL to load a script\n:inject VAR to make the angular injector inject a variable into local scope.\nThis requires Angular to be loaded in the current context.');var h=b.get(c.evaluator||"consoleEvaluator");h(c,a).then(function(b){g.evaluator=b,d(a,function(b){_(b.text().split(/\/\/\s*=>.+?(\n|$)(\/\/.+?(\n|$))*/)).map(function(a){return a&&a.trim()}).filter(function(a){return a&&""!==a}).each(g.evaluate,g).value();g.historyState=a.history.length})})}}}}).directive("gmUnwrapPromise",function(a){return{restrict:"A",scope:{promise:"=gmUnwrapPromise"},link:function(b,c){c.text("...\n"),a.when(b.promise).then(function(a){c.text(a.result+"\n"),c.addClass(a.type)})}}}),angular.module("AngularConsole").factory("consoleEvaluator",function(a){function b(b,c,d,e){var f=$('<iframe width="0" height="0"/>').css({visibility:"hidden"}),g=a.defer();b?(f.attr("src",b),f.on("load",function(){g.resolve(!0)})):g.resolve(!1),f.appendTo("body"),this.iframe=f[0],this.sandbox=this.iframe.contentWindow,!this.sandbox.eval&&this.sandbox.execScript&&this.sandbox.execScript("null");var h=this,i=function(){return c?_.reduce(c,function(a,b){return a.then(function(){return h.load(b)})},a.when([])):a.when([])};g.promise.then(i).then(function(){d&&h.inject(d),e()})}function c(a,b){return a.toLowerCase()<b.toLowerCase()?-1:1}return b.prototype.load=function(b){var c=a.defer(),d=document.createElement("script");return d.type="text/javascript",d.addEventListener("load",function(){c.resolve("Loaded "+b)},!1),d.src=b,this.iframe?(this.iframe.contentDocument.body.appendChild(d),c.promise):void 0},b.prototype.specialCommands=function(b){return b.indexOf(":load")>-1?this.load(b.substring(6)).then(function(a){return{result:a,type:"builtin"}}):b.indexOf(":inject")>-1?a.when({result:this.inject(b.substring(8).trim().split(/\s*,\s*/)),type:"builtin"}):!1},b.prototype.evaluate=function(b){if(!b)return!1;var c,d=this.specialCommands(b);if(d)return d;d={};var e=this,f=!1;try{c=this.sandbox.eval(b)}catch(g){c=g.toString(),f=!0}return a.when(c).then(function(a){return d.result=a,_.isUndefined(a)&&(d.type="undefined",d.result="undefined"),_.isNumber(a)&&(d.type="number"),_.isString(d.result)&&(d.type="string",d.result='"'+d.result.toString().replace(/"/g,'\\"')+'"'),_.isPlainObject(a)&&(d.type="object"),_.isArray(a)&&(d.type="array"),_.isFunction(d.result)&&(d.result=d.result.toString().replace(/"/g,'\\"'),d.type="function"),(_.isObject(d.result)||_.isArray(d.result))&&(d.result=e.stringify(d.result).replace(/"/g,'\\"')),f&&(d.type=void 0),d})},b.prototype.stringify=function d(a,b,e){var f,g,h="",i="",j=[],k=[],l=!1;e=e||[];try{i={}.toString.call(a)}catch(m){i="[object Object]"}for(g=0;g<e.length;g++)if(a===e[g]){l=!0;break}if(l)h="[circular]";else if("[object String]"===i)h='"'+a.replace(/"/g,'\\"')+'"';else if("[object Array]"===i){for(e.push(a),h="[",f=0;f<a.length;f++)j.push(d(a[f],b,e));h+=j.join(", ")+"]"}else if("[object Object]"===i){e.push(a),h="{";for(f in a)k.push(f);for(k.sort(c),f=0;f<k.length;f++)j.push(d(k[f],void 0,e)+": "+d(a[k[f]],b,e));h+=j.join(", ")+"}"}else if("[object Number]"===i)h=a+"";else if("[object Boolean]"===i)h=a?"true":"false";else if("[object Function]"===i)h=a.toString();else if(null===a)h="null";else if(void 0===a)h="undefined";else if(void 0===b){e.push(a),h=i+"{\n";for(f in a)k.push(f);for(k.sort(c),f=0;f<k.length;f++)try{j.push(k[f]+": "+d(a[k[f]],!0,e))}catch(m){"NS_ERROR_NOT_IMPLEMENTED"===m.name}h+=j.join(",\n")+"\n}"}else try{h=a+""}catch(m){}return h},b.prototype.inject=function(a){var b=this;try{_.each(a,function(a){b.sandbox.eval("var "+a+' = angular.element(document.body).injector().get("'+a+'");')})}catch(c){return"Error: Injection failed: "+c.message+"\nHave you initialized Angular properly?"}return"Injected the following into the current scope: "+a.join(", ")},function(c,d){var e=c.src,f=c.scripts&&d.$parent.$eval(c.scripts),g=c.inject&&d.$parent.$eval(c.inject),h=a.defer(),i=new b(e,f,g,function(){h.resolve(i)});return h.promise}});